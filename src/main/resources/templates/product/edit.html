<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ìˆ˜ì • - Linfinity Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            font-size: 2em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        form div {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        textarea {
            resize: vertical;
        }
        .current-image-area {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            text-align: center; /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ ì •ë ¬ */
        }
        .current-image-area img {
            max-width: 150px;
            max-height: 150px;
            /* â­ï¸ ì´ë¯¸ì§€ ê²½ë¡œ í…ìŠ¤íŠ¸ê°€ ì‚¬ë¼ì¡Œìœ¼ë¯€ë¡œ, ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ë„ì›ë‹ˆë‹¤. */
            display: inline-block;
            margin-top: 5px;
            border-radius: 4px;
            object-fit: contain;
        }
        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .button-group button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .submit-btn {
            background-color: #007bff;
            color: white;
        }
        .submit-btn:hover {
            background-color: #0056b3;
        }
        .cancel-btn {
            background-color: #6c757d;
            color: white;
        }
        .cancel-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ ìƒí’ˆ ìˆ˜ì •</h1>

    <form id="product-edit-form">
        <input type="hidden" id="productId" name="productId" th:value="${id}">

        <div>
            <label for="name">ìƒí’ˆ ì´ë¦„:</label>
            <input type="text" id="name" name="name" required>
        </div>

        <div>
            <label>í˜„ì¬ ì´ë¯¸ì§€:</label>
            <div class="current-image-area">
                <img id="currentImagePreview" src="" alt="í˜„ì¬ ìƒí’ˆ ì´ë¯¸ì§€" style="display: none;">
            </div>
            <input type="hidden" id="existingImageUrl" name="existingImageUrl">
        </div>

        <div>
            <label for="imageFile">ìƒˆ ì´ë¯¸ì§€ íŒŒì¼ (ì„ íƒ ì‚¬í•­):</label>
            <input type="file" id="imageFile" name="imageFile" accept="image/*">
        </div>

        <div>
            <label for="description">ìƒí’ˆ ì„¤ëª…:</label>
            <textarea id="description" name="description" rows="7" required></textarea>
        </div>

        <div>
            <label for="stock">ì¬ê³  ìˆ˜ëŸ‰:</label>
            <input type="number" id="stock" name="stock" required min="0">
        </div>

        <div class="button-group">
            <button type="button" class="cancel-btn" id="cancelButton">ì·¨ì†Œ</button>
            <button type="submit" class="submit-btn">ìˆ˜ì • ì™„ë£Œ</button>
        </div>
    </form>
</div>

<script th:inline="javascript">
    const productId = document.getElementById('productId').value;
    const form = document.getElementById('product-edit-form');
    const cancelButton = document.getElementById('cancelButton');

    document.addEventListener('DOMContentLoaded', fetchProductDetail);

    // 1. ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì™€ í¼ì— ì±„ìš°ê¸°
    function fetchProductDetail() {
        if (!productId) return;

        // ìƒí’ˆ ìƒì„¸ API í˜¸ì¶œ
        fetch(`/api/product/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(product => {
                document.getElementById('name').value = product.name;
                document.getElementById('description').value = product.description;
                document.getElementById('stock').value = product.stock;

                // ì´ë¯¸ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                const imageUrl = product.imageUrl && product.imageUrl.trim() !== ''
                    ? product.imageUrl
                    : '/images/default-placeholder.png'; // ëŒ€ì²´ ì´ë¯¸ì§€ ê²½ë¡œ

                document.getElementById('existingImageUrl').value = product.imageUrl || '';
                // â­ï¸ ì´ë¯¸ì§€ ê²½ë¡œ í…ìŠ¤íŠ¸ ë…¸ì¶œ ì½”ë“œ ì œê±° â­ï¸

                const imagePreview = document.getElementById('currentImagePreview');
                imagePreview.src = imageUrl;
                imagePreview.style.display = 'inline-block'; // í…ìŠ¤íŠ¸ ì œê±°ì— ë”°ë¼ display ì†ì„± ì¡°ì •
            })
            .catch(error => {
                console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/products';
            });
    }

    // 2. í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ìƒí’ˆ ìˆ˜ì • ìš”ì²­)
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData();

        // ìƒí’ˆ DTO êµ¬ì„±
        const productDto = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            stock: parseInt(document.getElementById('stock').value),
            // ìƒˆ íŒŒì¼ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ URLì„ DTOì— í¬í•¨
            imageUrl: document.getElementById('imageFile').files.length === 0
                ? document.getElementById('existingImageUrl').value
                : null
        };

        // DTOë¥¼ Blobìœ¼ë¡œ ë§Œë“¤ì–´ formDataì— ì¶”ê°€
        formData.append('requestDto', new Blob([JSON.stringify(productDto)], { type: 'application/json' }));

        // íŒŒì¼ ì¶”ê°€
        const imageFile = document.getElementById('imageFile').files[0];
        if (imageFile) {
            formData.append('imageFile', imageFile);
        }

        // ìƒí’ˆ ìˆ˜ì • API í˜¸ì¶œ (PUT /api/product/{productId})
        fetch(`/api/product/${productId}`, {
            method: 'PUT',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    // ì˜¤ë¥˜ ì‘ë‹µì˜ ë³¸ë¬¸ì„ ì½ì–´ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
                    return response.text().then(text => { throw new Error(text || 'ìˆ˜ì • ì‹¤íŒ¨') });
                }
                return response.text();
            })
            .then(() => {
                alert("ìƒí’ˆ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = `/products/${productId}`; // ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            })
            .catch(error => {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert(`ìƒí’ˆ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}`);
            });
    });

    // 3. ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    cancelButton.addEventListener('click', function() {
        if (confirm("ìˆ˜ì •ì„ ì·¨ì†Œí•˜ê³  ìƒì„¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.location.href = `/products/${productId}`;
        }
    });

</script>
</body>
</html>