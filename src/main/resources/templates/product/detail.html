<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ìƒì„¸ - Linfinity Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1000px;
            margin: 0 auto 20px auto;
            padding: 0 10px;
        }
        h1 {
            color: #333;
            font-size: 2em;
        }
        .product-container {
            display: flex;
            gap: 40px;
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ddd;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .image-area {
            flex: 1;
            max-width: 50%;
            text-align: center;
        }
        .image-area img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-area {
            flex: 1;
            padding-left: 20px;
        }
        .info-area h2 {
            margin-top: 0;
            font-size: 1.8em;
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .info-area p {
            margin: 10px 0;
        }
        .info-area strong {
            display: inline-block;
            width: 90px;
            color: #555;
            font-weight: bold;
        }
        .description-box {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .stock-info {
            font-size: 1.1em;
            color: #dc3545;
            font-weight: bold;
        }
        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-start;
        }
        .button-group button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .buy-btn {
            background-color: #28a745;
            color: white;
        }
        .buy-btn:hover {
            background-color: #218838;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #212529;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
        .list-btn {
            background-color: #6c757d;
            color: white;
        }
        .list-btn:hover {
            background-color: #5a6268;
        }
        .main-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .main-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<div class="header-container">
    <h1 id="page-title">ìƒí’ˆ ìƒì„¸ ì •ë³´</h1>
    <a href="/" class="main-btn">ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</a>
</div>

<div class="hidden" style="display: none;">
    <span id="currentUser" sec:authorize="isAuthenticated()" sec:authentication="name"></span>
    <span id="isSeller" sec:authorize="hasRole('SELLER')">true</span>
    <span id="isAdminOrRoot" sec:authorize="hasAnyRole('ADMIN', 'ROOT')">true</span>
</div>

<div id="product-detail" class="product-container">
    <p>ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<script th:inline="javascript">
    // URL ê²½ë¡œì—ì„œ ìƒí’ˆ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const productId = window.location.pathname.split("/").pop();

    document.addEventListener('DOMContentLoaded', fetchProductDetail);

    // ìƒí’ˆ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function fetchProductDetail() {
        if (!productId || isNaN(productId)) {
            document.getElementById('product-detail').innerHTML = '<p style="color: red; text-align: center;">ìœ íš¨í•œ ìƒí’ˆ IDê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
        fetch(`/api/product/${productId}`)
            .then(response => {
                if (response.status === 404) {
                    throw new Error('ìƒí’ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                if (!response.ok) {
                    throw new Error('ë°ì´í„° ë¡œë“œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜');
                }
                return response.json();
            })
            .then(product => {
                // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
                document.getElementById('page-title').textContent = product.name;

                const detailContainer = document.getElementById('product-detail');
                if (!detailContainer) return;

                detailContainer.className = 'product-container';

                const imageUrl = product.imageUrl && product.imageUrl.trim() !== ''
                    ? product.imageUrl
                    : '/images/default-placeholder.png';

                // ìƒí’ˆ ë²ˆí˜¸(ID)ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ë¶€ë¶„ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
                detailContainer.innerHTML = `
                    <div class="image-area">
                        <img src="${imageUrl}" alt="${product.name} ì´ë¯¸ì§€">
                    </div>

                    <div class="info-area">
                        <h2>${product.name}</h2>
                        <p><strong>íŒë§¤ì:</strong> ${product.sellerName}</p>
                        <p><strong>ì¬ê³  ìˆ˜ëŸ‰:</strong> <span class="stock-info">${product.stock}ê°œ</span></p>

                        <div class="description-box">
                            <h4>ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h4>
                            <p>${product.description}</p>
                        </div>

                        <div class="button-group">
                            <button onclick="purchaseProduct()" class="buy-btn">ğŸ›’ ìƒí’ˆ êµ¬ë§¤</button>

                            <a id="editLink" href="/products/edit/${product.productId}" class="hidden">
                                <button class="edit-btn">âœï¸ ìƒí’ˆ ìˆ˜ì •</button>
                            </a>

                            <a href="/products">
                                <button class="list-btn">ğŸ”™ ëª©ë¡ìœ¼ë¡œ</button>
                            </a>
                        </div>
                    </div>
                `;

                // ê¶Œí•œ ì²´í¬ ë° ë²„íŠ¼ ë…¸ì¶œ ì‹¤í–‰
                checkAuthAndShowButtons(product);

            })
            .catch(error => {
                console.error('ìƒí’ˆ ìƒì„¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                const detailContainer = document.getElementById('product-detail');
                if (detailContainer) {
                    detailContainer.innerHTML = `<p style="color: red; text-align: center; margin-top: 50px;">ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                }
            });
    }

    /**
     * ê¶Œí•œì„ ì²´í¬í•˜ì—¬ ìƒí’ˆ ìˆ˜ì • ë²„íŠ¼ì„ ë…¸ì¶œí•©ë‹ˆë‹¤.
     */
    function checkAuthAndShowButtons(product) {
        // 1. ë¡œê·¸ì¸ ì‚¬ìš©ì ì´ë¦„ ë° ê¶Œí•œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const currentUserElement = document.getElementById('currentUser');
        const currentUser = currentUserElement ? currentUserElement.innerText : '';
        const sellerName = product.sellerName;

        const isSellerElement = document.getElementById('isSeller');
        const isAdminOrRootElement = document.getElementById('isAdminOrRoot');

        // HTML ìš”ì†Œê°€ ì¡´ì¬í•˜ë©´ í•´ë‹¹ ê¶Œí•œì„ ê°€ì§„ ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
        const isSeller = !!isSellerElement;
        const isAdminOrRoot = !!isAdminOrRootElement;

        // 2. â­ï¸ ìˆ˜ì • ê¶Œí•œ ì¡°ê±´ í™•ì¸: â­ï¸
        // (ADMIN ë˜ëŠ” ROOT ê¶Œí•œì´ ìˆëŠ” ê²½ìš°) OR (SELLER ê¶Œí•œì´ ìˆê³  í˜„ì¬ ì‚¬ìš©ìê°€ íŒë§¤ìì¸ ê²½ìš°)
        const canEdit = isAdminOrRoot || (isSeller && currentUser && currentUser === sellerName);

        // 3. ìˆ˜ì • ë§í¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const editLink = document.getElementById('editLink');

        // 4. ê¶Œí•œì´ ìˆì„ ê²½ìš° ë²„íŠ¼ ë…¸ì¶œ
        if (editLink && canEdit) {
            editLink.classList.remove('hidden');
        }
    }

    /**
     * ìƒí’ˆ êµ¬ë§¤ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—…ì„ ë„ìš°ëŠ” í•¨ìˆ˜
     */
    function purchaseProduct() {
        alert("ğŸ‰ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
</script>
<style>
    /* JavaScriptì—ì„œ ì‚¬ìš©í•˜ëŠ” ìˆ¨ê¹€ í´ë˜ìŠ¤ */
    .hidden {
        display: none !important;
    }
</style>
</body>
</html>