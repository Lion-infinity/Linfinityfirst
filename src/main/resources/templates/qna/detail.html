<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>질문 상세 - Linfinity Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-10 flex justify-center">

<div class="hidden">
    <span id="currentUser" sec:authorize="isAuthenticated()" sec:authentication="name"></span>
    <span id="isAdmin" sec:authorize="hasAnyRole('ROOT', 'ADMIN')">true</span>
</div>

<div class="bg-white p-8 rounded shadow-md w-full max-w-3xl">
    <div class="border-b pb-6 mb-6">
        <h1 id="titleText" class="text-3xl font-bold mb-2"></h1>
        <input type="text" id="titleInput" class="hidden w-full text-2xl font-bold mb-2 border rounded px-2 py-1">

        <div class="text-gray-500 text-sm mb-4">
            작성자: <span id="username" class="font-semibold text-gray-700"></span> |
            작성일: <span id="createdAt"></span>
        </div>

        <div id="questionText" class="text-gray-800 whitespace-pre-wrap leading-relaxed"></div>
        <textarea id="questionInput" class="hidden w-full border rounded px-3 py-2 h-40"></textarea>

        <div class="mt-4 flex space-x-2 justify-end" id="userBtnGroup">
            <button onclick="enableEditMode()" id="editBtn" class="hidden text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded">수정</button>
            <button onclick="deleteQna()" id="delBtn" class="hidden text-sm bg-red-100 hover:bg-red-200 text-red-700 py-1 px-3 rounded">삭제</button>

            <button onclick="updateQna()" id="saveBtn" class="hidden text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded">저장</button>
            <button onclick="cancelEdit()" id="cancelBtn" class="hidden text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 py-1 px-3 rounded">취소</button>
        </div>
    </div>

    <div id="answerSection" class="bg-gray-50 p-6 rounded mb-6 hidden">
        <h3 class="font-bold text-lg text-green-700 mb-2">💡 관리자 답변</h3>
        <div id="answerContent" class="text-gray-700 whitespace-pre-wrap"></div>
        <div id="answeredAt" class="text-xs text-gray-400 mt-2 text-right"></div>
    </div>

    <div class="mt-8 pt-6 border-t" sec:authorize="hasAnyRole('ADMIN', 'SELLER', 'ROOT')">
        <h3 class="font-bold text-gray-700 mb-2">답변 달기 (관리자/판매자)</h3>
        <textarea id="newAnswer" class="w-full px-3 py-2 border rounded h-24 mb-2" placeholder="답변 내용을 입력하세요"></textarea>
        <button onclick="submitAnswer()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
            답변 등록
        </button>
    </div>

    <div class="mt-6">
        <a href="/qna" class="text-blue-500 hover:underline">← 목록으로 돌아가기</a>
    </div>
</div>

<script>
    const qnaId = window.location.pathname.split("/").pop();
    let originalTitle = "";
    let originalQuestion = "";

    // 1. 상세 정보 가져오기 (알림창 제거)
    window.onload = function() {
        fetch(`/api/qna/${qnaId}`)
            .then(response => {
                // 서버 설정이 수정되었으므로, 401/403 응답이 오더라도 데이터가 없는 경우를 대비하여
                // response.ok가 false인 경우만 에러로 처리하고 나머지는 진행합니다.
                if (!response.ok) {
                    throw new Error("Failed to fetch QnA details.");
                }
                return response.json();
            })
            .then(data => {
                // 데이터 바인딩
                document.getElementById('titleText').innerText = data.title;
                document.getElementById('username').innerText = data.username;
                document.getElementById('questionText').innerText = data.question;
                document.getElementById('createdAt').innerText = data.questionCreatedAt ? data.questionCreatedAt.replace('T', ' ') : '';

                // 수정 취소를 위해 원본 저장
                originalTitle = data.title;
                originalQuestion = data.question;

                // 권한 체크 및 버튼 노출 로직 (익명 사용자는 currentUser가 빈 문자열이므로 버튼이 숨겨짐)
                const currentUser = document.getElementById('currentUser').innerText;
                const isAdmin = document.getElementById('isAdmin') !== null;

                if (currentUser === data.username) {
                    document.getElementById('editBtn').classList.remove('hidden');
                }

                if (currentUser === data.username || isAdmin) {
                    document.getElementById('delBtn').classList.remove('hidden');
                }

                // 답변이 있으면 보여주기
                if (data.answered) {
                    document.getElementById('answerSection').classList.remove('hidden');
                    document.getElementById('answerContent').innerText = data.answer;
                    document.getElementById('answeredAt').innerText = '답변일: ' + (data.answeredAt ? data.answeredAt.substring(0, 10) : '');
                }
            })
            .catch(error => {
                // [최종 수정] 어떤 에러가 발생하더라도 사용자에게는 알림을 띄우지 않습니다.
                console.error('Fetch Error:', error);
            });
    };

    // 2. 질문 삭제 요청 (DELETE)
    function deleteQna() {
        if(!confirm("정말로 삭제하시겠습니까?")) return;

        fetch(`/api/qna/${qnaId}`, {
            method: 'DELETE'
        })
            .then(async response => {
                if (response.ok) {
                    alert("삭제되었습니다.");
                    window.location.href = "/qna";
                } else {
                    // 삭제는 권한이 필요하므로 실패 시 메시지 표시
                    alert("삭제 실패! (본인의 글이 아니거나 권한이 없습니다)");
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // 3. 수정 모드 진입 (UI 변경)
    function enableEditMode() {
        document.getElementById('titleText').classList.add('hidden');
        document.getElementById('questionText').classList.add('hidden');
        document.getElementById('editBtn').classList.add('hidden');
        document.getElementById('delBtn').classList.add('hidden');

        const titleInput = document.getElementById('titleInput');
        const questionInput = document.getElementById('questionInput');

        titleInput.classList.remove('hidden');
        questionInput.classList.remove('hidden');
        titleInput.value = originalTitle;
        questionInput.value = originalQuestion;

        document.getElementById('saveBtn').classList.remove('hidden');
        document.getElementById('cancelBtn').classList.remove('hidden');
    }

    // 4. 수정 취소
    function cancelEdit() {
        document.getElementById('titleText').classList.remove('hidden');
        document.getElementById('questionText').classList.remove('hidden');
        document.getElementById('editBtn').classList.remove('hidden');
        document.getElementById('delBtn').classList.remove('hidden');

        document.getElementById('titleInput').classList.add('hidden');
        document.getElementById('questionInput').classList.add('hidden');
        document.getElementById('saveBtn').classList.add('hidden');
        document.getElementById('cancelBtn').classList.add('hidden');
    }

    // 5. 질문 수정 요청 (PUT)
    function updateQna() {
        const data = {
            title: document.getElementById('titleInput').value,
            question: document.getElementById('questionInput').value
        };

        fetch(`/api/qna/${qnaId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(async response => {
                if (response.ok) {
                    alert("수정되었습니다.");
                    window.location.reload();
                } else {
                    alert("수정 실패! (본인의 글이 아니거나 권한이 없습니다)");
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // 6. 답변 등록
    function submitAnswer() {
        const answerText = document.getElementById('newAnswer').value;
        if(!answerText) {
            alert("내용을 입력해주세요.");
            return;
        }

        fetch(`/api/qna/${qnaId}/answer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answer: answerText })
        })
            .then(async response => {
                if (response.ok) {
                    alert("답변이 등록되었습니다.");
                    window.location.reload();
                } else {
                    alert("답변 등록 실패! (권한이 없거나 오류 발생)");
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>

</body>
</html>