<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>공지 상세</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-10 flex justify-center">
<div class="bg-white p-8 rounded shadow-md w-full max-w-3xl">
    <div class="border-b pb-4 mb-4">
        <!-- 제목 표시 및 수정 입력 -->
        <h1 id="titleText" class="text-3xl font-bold mb-2"></h1>
        <input type="text" id="titleInput" class="hidden w-full text-2xl font-bold mb-2 border rounded px-2 py-1">

        <div class="flex justify-between text-gray-500 text-sm">
            <span>작성자: <span id="writer" class="font-semibold text-gray-700"></span></span>
            <span>조회수: <span id="views"></span> | <span id="date"></span></span>
        </div>
    </div>

    <!-- 내용 표시 및 수정 입력 -->
    <div id="contentText" class="text-gray-800 whitespace-pre-wrap mb-10 min-h-[200px] leading-relaxed"></div>
    <textarea id="contentInput" class="hidden w-full border rounded px-3 py-2 h-64 mb-4"></textarea>

    <div class="flex justify-between items-center pt-4 border-t">
        <a href="/notices" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition">목록으로</a>

        <!-- 관리자만 보이는 버튼 그룹 -->
        <div sec:authorize="hasAnyRole('ADMIN', 'ROOT', 'ROLE_ADMIN', 'ROLE_ROOT')" class="space-x-2">
            <!-- 기본 버튼 -->
            <button onclick="enableEditMode()" id="editBtn" class="bg-blue-100 text-blue-600 px-4 py-2 rounded hover:bg-blue-200 transition">수정</button>
            <button onclick="deleteNotice()" id="delBtn" class="bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200 transition">삭제</button>

            <!-- 수정 모드 버튼 -->
            <button onclick="updateNotice()" id="saveBtn" class="hidden bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">저장</button>
            <button onclick="cancelEdit()" id="cancelBtn" class="hidden bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">취소</button>
        </div>
    </div>
</div>

<script>
    const id = window.location.pathname.split("/").pop();
    let originalTitle = "";
    let originalContent = "";

    // 상세 정보 로드
    fetch(`/api/notices/${id}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('titleText').innerText = data.title;
            document.getElementById('writer').innerText = data.writerName;
            document.getElementById('contentText').innerText = data.content;
            document.getElementById('views').innerText = data.viewCount;
            document.getElementById('date').innerText = data.createdAt ? data.createdAt.substring(0, 10) : '';

            // 수정 취소용 원본 저장
            originalTitle = data.title;
            originalContent = data.content;
        })
        .catch(err => alert("공지사항을 불러올 수 없습니다."));

    // 삭제
    function deleteNotice() {
        if(!confirm("정말로 삭제하시겠습니까?")) return;
        fetch(`/api/notices/${id}`, { method: 'DELETE' })
            .then(res => {
                if(res.ok) { alert("삭제되었습니다."); location.href="/notices"; }
                else alert("삭제 실패 (권한이 없습니다)");
            });
    }

    // 수정 모드 진입
    function enableEditMode() {
        // 텍스트 숨기기
        document.getElementById('titleText').classList.add('hidden');
        document.getElementById('contentText').classList.add('hidden');
        document.getElementById('editBtn').classList.add('hidden');
        document.getElementById('delBtn').classList.add('hidden');

        // 입력창 보이기 & 값 채우기
        const titleInput = document.getElementById('titleInput');
        const contentInput = document.getElementById('contentInput');
        titleInput.classList.remove('hidden');
        contentInput.classList.remove('hidden');
        titleInput.value = originalTitle;
        contentInput.value = originalContent;

        // 버튼 보이기
        document.getElementById('saveBtn').classList.remove('hidden');
        document.getElementById('cancelBtn').classList.remove('hidden');
    }

    // 수정 취소
    function cancelEdit() {
        document.getElementById('titleText').classList.remove('hidden');
        document.getElementById('contentText').classList.remove('hidden');
        document.getElementById('editBtn').classList.remove('hidden');
        document.getElementById('delBtn').classList.remove('hidden');

        document.getElementById('titleInput').classList.add('hidden');
        document.getElementById('contentInput').classList.add('hidden');
        document.getElementById('saveBtn').classList.add('hidden');
        document.getElementById('cancelBtn').classList.add('hidden');
    }

    // 수정 요청
    function updateNotice() {
        const data = {
            title: document.getElementById('titleInput').value,
            content: document.getElementById('contentInput').value
        };

        fetch(`/api/notices/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(async response => {
                if (response.ok) {
                    alert("공지사항이 수정되었습니다.");
                    window.location.reload();
                } else {
                    const errorText = await response.text();
                    alert("수정 실패: " + errorText);
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>
</body>
</html>